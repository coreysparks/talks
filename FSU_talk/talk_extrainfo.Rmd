---
title: "talk_extrainfo"
author: "Corey Sparks PhD"
date: "10/6/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction
* Black-White disparities in mortality rates persist
* Most research focuses on individual level factors 
    + SES, Health behaviors
* More recent work is multilevel 
    + Context of health, neighborhood conditions
* Role of residential segregation on aggregate mortality rates still poorly understood


## Segregation & Mortality

* Williams and Collins (2001) offer one of the first conceptual pieces to link segregation to poor health.
* Segregation spatially and socially patterns:
    + Poverty
    + Economic and educational opportunities
    + Social order or disorder
    + Access to resources 
* Segregation could lead to better health outcomes (political representation, social support, cohesion) 

## Research Questions
* Does the effect of segregation produce the same disparity in black and white mortality rates over time?
* Do counties with persistently high segregation show the same mortality disadvantage for both black and white mortality rates?
* Does segregation have any protective advantage on county-level mortality rates?
    + For black mortality specifically
```{r, echo=FALSE}
options("scipen"=100, "digits"=4)
```
## Data

* NCHS [Compressed Mortality File](http://www.cdc.gov/nchs/data_access/cmf.htm)
    + County - level counts of deaths by year, age, sex, race/ethnicity and cause of death
    + 1980 to 2010
    + Age, sex and race _(white & black)_ specific rates for all US counties
    + In total: `r  8776385+9691181+17280710` deaths in the data
    + Standardized to 2000 Standard US population age structure
    + Rates stratified by race and sex for each county by year
    + n = 2 sexes * 2 races * 3106 counties * 31 years = `r 2*2*31*3106` observations 
    + *Analytic* n = 315,808 nonzero rates

## Data - Access
* You can basically get these data from the CDC Wonder [website](http://wonder.cdc.gov/mortsql.html)
* Suppresses counts where the number of deaths is less than 10
* Rates are labeled as "__unreliable__" when the rate is calculated with a numerator of 20 or less
    + Big problem for small population counties
    + Still a problem for large population counties!
* Restricted use data allows access to __ALL__ data


## Data - Example
Bexar County, TX 1980 - 1982
```{r echo=FALSE, warning=FALSE}
library(knitr)
load("talk326.Rdata")
#sdadata2$year<-sdadata2$year
sdadata2$mortality<-sdadata2$std_rate
sdadata2$race_sex<-factor(ifelse(sdadata2$black==1&sdadata2$male==0, "Black Female",
                            ifelse(sdadata2$black==1&sdadata2$male==1, "Black Male",
                                   ifelse(sdadata2$black==0&sdadata2$male==0, "White Female","White Male"))))
sdadata2<-sdadata2[order(sdadata2$cofips, sdadata2$year, sdadata2$male, sdadata2$black), ]

bex1<-sdadata2[sdadata2$cofips=="48029", c("cofips","year", "race_sex", "mortality")] ; bex1<-bex1[is.na(bex1$cofips)==F,]
mon1<-sdadata2[sdadata2$cofips=="12073", c("cofips","year", "race_sex", "mortality")];mon1<-mon1[is.na(mon1$cofips)==F,]
library(knitr)
#print(head(bex1, n=12), row.names=F, digits=2)
knitr::kable(head(bex1, n=12), row.names = F, col.names = c("County", "Year", "Race-Sex", "Rate"),align = "c")
```

## Data - Example
Leon County, FL 1980 - 1982
```{r, echo=FALSE}
#print(head(mon1, n=12), row.names=F, digits=2)
knitr::kable(head(mon1, n=12), row.names = F, col.names = c("County", "Year", "Race-Sex", "Rate"),align = "c")
```

## Data - Example
County specific temporal trends 1980 - 2010

```{r, message=FALSE, echo=FALSE, fig.width=8, fig.height=5, warning=FALSE}
bex1$race<-substr(bex1$race_sex,1,5)
library(ggplot2)
p1<-ggplot(bex1,aes(year,mortality),xlab="Year",ylab="Mortality Rate")+
  geom_line(aes(colour=race_sex ) , lwd=1.25)+
  ylab("Mortality Rate per 1,000")+
  xlab("Year")+
  ggtitle("Bexar County, TX, 1980 - 2010")+
  ylim(c(0, 35))+theme(legend.position="none")+
  scale_color_brewer(type="qual", "Set1")

p2<-ggplot(mon1,aes(year,mortality),xlab="Year")+geom_line(aes(colour=race_sex), lwd=1.25)+ylab("")+xlab("Year")+ggtitle("Leon County, FL, 1980 - 2010")+ylim(c(0,35))+scale_color_brewer(type="qual", "Set1")+theme(legend.text=element_text(size=8),
        legend.title = element_blank())

library(patchwork)
plot_layout(p1+ p2)


```

## Data - Example of Geographic Variation
Spatial Distribution of White & Black Mortality in the US: 1980-1985 Period
```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(maptools)
library(tigris)
spdat<- counties(cb=T, refresh=T)
sts<- states(cb=T)
spdat$GEOID10<-paste(spdat$STATEFP,spdat$COUNTYFP,sep = "")
#plot(spdat)
sdadata2$state<-substr(sdadata2$cofips,1,2)
meansw<-aggregate(std_rate~cofips, data=sdadata2[sdadata2$black==0&sdadata2$year%in%1980:1985,], mean, na.rm=T)

meansb<-aggregate(std_rate~cofips, data=sdadata2[sdadata2$black==1&sdadata2$year%in%1980:1985,], mean, na.rm=T)
names(meansb)<-c("cofips", "std_rate_bl")
#mdat<-spdat@data
library(tigris)
mdat<- geo_join(spdat, meansw, by_sp="GEOID10",by_df="cofips" )
mdat$whmort<-mdat$std_rate
mdat<-geo_join(mdat, meansb,by_sp="GEOID10",by_df="cofips")
mdat$blmort<-mdat$std_rate_bl
#spdat@data<-mdat
```


```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(RColorBrewer)
cols<-brewer.pal(n=9, "Reds")
library(sf)
msf<-st_as_sf(mdat)
sts<-st_as_sf(sts)
#msf_lcc <- st_transform(msf,test)
msf$wmort_q<-cut(msf$whmort, breaks = quantile(sdadata2$std_rate, probs = seq(0,1,.2), na.rm = T),include.lowest = T)
msf$bmort_q<-cut(msf$blmort, breaks = quantile(sdadata2$std_rate, probs = seq(0,1,.2), na.rm = T),include.lowest = T)

library(ggplot2);library(dplyr); library(forcats)
msf<-st_transform(msf, crs = 2163)
sts<-st_transform(sts, crs=2163)
msf<-msf%>%
  filter(!STATEFP%in%c("02","15","60","64", "66", "68","69","70", "72","74", "78" ))
sts<-sts%>%filter(!STATEFP%in%c("02","15","60","64", "66", "68","69","70", "72","74", "78"))%>%st_boundary()


p1<-ggplot() +
  geom_sf(data=msf,aes(fill = wmort_q, color=wmort_q)) +
  scale_fill_brewer("Quantile", palette = "Blues", na.value="grey") +
  scale_color_brewer("Quantile",palette = "Blues", na.value="grey")+
  geom_sf(data=sts, color="black")+
  ggtitle(label = "White Mortality Rate", subtitle = "1980- 1985 Period")

# p<-ggplot() +
# geom_sf(data=msf,aes(fill = wmort_q, color=wmort_q)) +
# scale_fill_brewer(palette = "Blues") +
# scale_color_brewer(palette = "Blues")+
# geom_sf(data=sts, color="black")

p2<-ggplot() +
  geom_sf(data=msf,aes(fill = bmort_q, color=bmort_q)) +
  scale_fill_brewer("Quantile", palette = "Blues", na.value="grey") +
  scale_color_brewer("Quantile", palette = "Blues", na.value="grey")+
  geom_sf(data=sts, color="black")+
  ggtitle(label = "Black Mortality Rate", subtitle = "1980- 1985 Period")

plot_layout(p1+p2)

```

## Data - Example of Geographic Variation
Spatial Distribution of White & Black Mortality in the US: 2005-2010 Period
```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(maptools)
spdat<- tigris::counties(cb=T, year=2010)
sts<- tigris::states(cb=T)
spdat$GEOID10<-paste(spdat$STATE,spdat$COUNTY,sep = "")
#plot(spdat)
sdadata2$state<-substr(sdadata2$cofips,1,2)
meansw<-aggregate(std_rate~cofips, data=sdadata2[sdadata2$black==0&sdadata2$year%in%2000:2010,], mean, na.rm=T)

meansb<-aggregate(std_rate~cofips, data=sdadata2[sdadata2$black==1&sdadata2$year%in%2000:2010,], mean, na.rm=T)
names(meansb)<-c("cofips", "std_rate_bl")
#mdat<-spdat@data
library(tigris)
mdat<- geo_join(spdat, meansw, by_sp="GEOID10",by_df="cofips" )
mdat$whmort<-mdat$std_rate

mdat<-geo_join(mdat, meansb,by_sp="GEOID10",by_df="cofips")
mdat$blmort<-mdat$std_rate_bl
#spdat@data<-mdat
```

```{r,results='hide',echo=FALSE, message=FALSE, warning=FALSE}
library(maptools)
library(tigris)
spdat<- counties(cb=T, refresh=T)
sts<- states(cb=T)
spdat$GEOID10<-paste(spdat$STATEFP,spdat$COUNTYFP,sep = "")
#plot(spdat)
sdadata2$state<-substr(sdadata2$cofips,1,2)
meansw<-aggregate(std_rate~cofips, data=sdadata2[sdadata2$black==0&sdadata2$year%in%1980:1985,], mean, na.rm=T)

meansb<-aggregate(std_rate~cofips, data=sdadata2[sdadata2$black==1&sdadata2$year%in%1980:1985,], mean, na.rm=T)
names(meansb)<-c("cofips", "std_rate_bl")
#mdat<-spdat@data
library(tigris)
mdat<- geo_join(spdat, meansw, by_sp="GEOID10",by_df="cofips" )
mdat$whmort<-mdat$std_rate
mdat<-geo_join(mdat, meansb,by_sp="GEOID10",by_df="cofips")
mdat$blmort<-mdat$std_rate_bl

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(RColorBrewer)
cols<-brewer.pal(n=9, "Reds")
library(sf)
msf<-st_as_sf(mdat)
sts<-st_as_sf(sts)
#msf_lcc <- st_transform(msf,test)
msf$wmort_q<-cut(msf$whmort, breaks = quantile(sdadata2$std_rate, probs = seq(0,1,.2), na.rm = T),include.lowest = T)
msf$bmort_q<-cut(msf$blmort, breaks = quantile(sdadata2$std_rate, probs = seq(0,1,.2), na.rm = T),include.lowest = T)

library(ggplot2);library(dplyr); library(forcats)
msf<-st_transform(msf, crs = 2163)
sts<-st_transform(sts, crs=2163)
msf<-msf%>%
  filter(!STATEFP%in%c("02","15","60","64", "66", "68","69","70", "72","74", "78" ))
sts<-sts%>%filter(!STATEFP%in%c("02","15","60","64", "66", "68","69","70", "72","74", "78"))%>%st_boundary()


p1<-ggplot() +
  geom_sf(data=msf,aes(fill = wmort_q, color=wmort_q)) +
  scale_fill_brewer("Quantile", palette = "Blues", na.value="grey") +
  scale_color_brewer("Quantile",palette = "Blues", na.value="grey")+
  geom_sf(data=sts, color="black")+
  ggtitle(label = "White Mortality Rate", subtitle = "1980- 1985 Period")

# p<-ggplot() +
# geom_sf(data=msf,aes(fill = wmort_q, color=wmort_q)) +
# scale_fill_brewer(palette = "Blues") +
# scale_color_brewer(palette = "Blues")+
# geom_sf(data=sts, color="black")

p2<-ggplot() +
  geom_sf(data=msf,aes(fill = bmort_q, color=bmort_q)) +
  scale_fill_brewer("Quantile", palette = "Blues", na.value="grey") +
  scale_color_brewer("Quantile", palette = "Blues", na.value="grey")+
  geom_sf(data=sts, color="black")+
  ggtitle(label = "Black Mortality Rate", subtitle = "1980- 1985 Period")

p1/p2 +plot_layout( )

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(RColorBrewer)
cols<-brewer.pal(n=9, "Reds")
library(sf)
msf<-st_as_sf(mdat)
sts<-st_as_sf(sts)
#msf_lcc <- st_transform(msf,test)
msf$wmort_q<-cut(msf$whmort, breaks = quantile(sdadata2$std_rate, probs = seq(0,1,.2), na.rm = T),include.lowest = T)
msf$bmort_q<-cut(msf$blmort, breaks = quantile(sdadata2$std_rate, probs = seq(0,1,.2), na.rm = T),include.lowest = T)

library(ggplot2);library(dplyr); library(forcats)
msf<-st_transform(msf, crs = 2163)
sts<-st_transform(sts, crs=2163)
msf<-msf%>%
  filter(!STATEFP%in%c("02","15", "72" ))
sts<-sts%>%filter(!STATEFP%in%c("02","15","60", "66","69", "72", "78"))%>%st_boundary()


p1<-ggplot() +
  geom_sf(data=msf,aes(fill = wmort_q, color=wmort_q)) +
  scale_fill_brewer("Quantile", palette = "Blues", na.value="grey") +
  scale_color_brewer("Quantile",palette = "Blues", na.value="grey")+
  geom_sf(data=sts, color="black")+
  ggtitle(label = "White Mortality Rate", subtitle = "2005 - 2010 Period")

# p<-ggplot() +
# geom_sf(data=msf,aes(fill = wmort_q, color=wmort_q)) +
# scale_fill_brewer(palette = "Blues") +
# scale_color_brewer(palette = "Blues")+
# geom_sf(data=sts, color="black")

p2<-ggplot() +
  geom_sf(data=msf,aes(fill = bmort_q, color=bmort_q)) +
  scale_fill_brewer("Quantile", palette = "Blues", na.value="grey") +
  scale_color_brewer("Quantile", palette = "Blues", na.value="grey")+
  geom_sf(data=sts, color="black")+
  ggtitle(label = "Black Mortality Rate", subtitle = "2005 - 2010 Period")

plot_layout(p1+p2)
```


##State Examples
```{r, echo=FALSE}
p1<-ggplot() +
  geom_sf(data=msf[msf$STATEFP=="48", ],aes(fill = wmort_q, color=wmort_q)) +
  scale_fill_brewer("Quantile", palette = "Blues", na.value="grey") +
  scale_color_brewer("Quantile",palette = "Blues", na.value="grey")+
  geom_sf(data=sts[sts$STATEFP=="48",], color="black")+
  ggtitle(label = "White Mortality Rate", subtitle = "1980- 1985 Period")


# p<-ggplot() +
# geom_sf(data=msf,aes(fill = wmort_q, color=wmort_q)) +
# scale_fill_brewer(palette = "Blues") +
# scale_color_brewer(palette = "Blues")+
# geom_sf(data=sts, color="black")

p2<-ggplot() +
  geom_sf(data=msf[msf$STATEFP=="48",],aes(fill = bmort_q, color=bmort_q)) +
  scale_fill_brewer("Quantile", palette = "Blues", na.value="grey") +
  scale_color_brewer("Quantile", palette = "Blues", na.value="grey")+
  geom_sf(data=sts[sts$STATEFP=="48",], color="black")+
  ggtitle(label = "Black Mortality Rate", subtitle = "1980- 1985 Period")

plot_layout(p1+p2)

```

##

```{r, echo=F, results='hide'}
meansw<-aggregate(std_rate~cofips, data=sdadata2[sdadata2$black==0&sdadata2$year%in%2005:2010,], mean, na.rm=T)

meansb<-aggregate(std_rate~cofips, data=sdadata2[sdadata2$black==1&sdadata2$year%in%2005:2010,], mean, na.rm=T)
names(meansb)<-c("cofips", "std_rate_bl")
#mdat<-spdat@data
library(tigris)
sts<- states(cb=T)
mdat<- geo_join(spdat, meansw, by_sp="GEOID10",by_df="cofips" )
mdat$whmort<-mdat$std_rate
mdat<-geo_join(mdat, meansb,by_sp="GEOID10",by_df="cofips")
mdat$blmort<-mdat$std_rate_bl
msf<-st_as_sf(mdat)
sts<-st_as_sf(sts)
msf$wmort_q<-cut(msf$whmort, breaks = quantile(c(msf$whmort, msf$blmort), probs = seq(0,1,.2), na.rm = T),include.lowest = T)
msf$bmort_q<-cut(msf$blmort, breaks = quantile(c(msf$whmort, msf$blmort), probs = seq(0,1,.2), na.rm = T),include.lowest = T)

library(ggplot2);library(dplyr); library(forcats)
msf<-st_transform(msf, crs = 2163)
sts<-st_transform(sts, crs=2163)
msf<-msf%>%
  filter(!STATEFP%in%c("02","15", "72" ))
sts<-sts%>%filter(!STATEFP%in%c("02","15","60", "66","69", "72", "78"))%>%st_boundary()


p1<-ggplot() +
  geom_sf(data=msf[msf$STATEFP=="12", ],aes(fill = bmort_q, color=bmort_q)) +
  scale_fill_brewer("Quantile", palette = "Blues", na.value="grey") +
  scale_color_brewer("Quantile",palette = "Blues", na.value="grey")+
  geom_sf(data=sts[sts$STATEFP=="12",], color="black")+
  ggtitle(label = "Black Mortality Rate", subtitle = "2005 - 2010 Period")

# p<-ggplot() +
# geom_sf(data=msf,aes(fill = wmort_q, color=wmort_q)) +
# scale_fill_brewer(palette = "Blues") +
# scale_color_brewer(palette = "Blues")+
# geom_sf(data=sts, color="black")

p2<-ggplot() +
  geom_sf(data=msf[msf$STATEFP=="12",],aes(fill = wmort_q, color=wmort_q)) +
  scale_fill_brewer("Quantile", palette = "Blues", na.value="grey") +
  scale_color_brewer("Quantile", palette = "Blues", na.value="grey")+
  geom_sf(data=sts[sts$STATEFP=="12",], color="black")+
  ggtitle(label = "White Mortality Rate", subtitle = "2005 - 2010 Period")

plot_layout(p1+p2)
```


```{r}
fl<- filter(sdadata2, state==12)
mod<- std_rate~male+black+year+
  f(year2,model="iid")+f(conum, model="iid")
fit <- inla(mod,data=fl, family="gaussian",
            control.predictor = list(link=1, compute=T), verbose=FALSE  )

fls<-counties(state="FL", cb=T)
fls$struct<-1:dim(fls)[1] 
nbs<-spdep::poly2nb(fls)
mat <- spdep::nb2mat(nbs, style="B",zero.policy=TRUE)
colnames(mat) <- rownames(mat) 
mat <- as.matrix(mat[1:dim(mat)[1], 1:dim(mat)[1]])


fl<-left_join(fl, fls, by =c("cofips"="GEOID"))
fl$year2<-fl$year-1995
fl$year3<-fl$year
fl$bl2<-fl$black
fl$struct2<-fl$struct
fl$int <- as.numeric(interaction(fl$year, fl$cofips))

spdep::nb2INLA("cl_graph",nbs)
am_adj <-paste(getwd(),"/cl_graph",sep="")
H<-inla.read.graph(filename="cl_graph")

mod2<-std_rate~male+black+scale(lths)+
  f(year2, model = "rw1",constr = T, scale.model = T)+
f(struct, model="besag", graph="cl_graph", constr = T, scale.model = T)+
#f(int, model="iid")+
f(year3, bl2,  model="iid")+
  f(struct2, bl2, model="besag", graph="cl_graph", constr = T, scale.model = T)

fit2 <- inla(mod2,data=fl,
             family="gaussian",
            control.predictor = list(link=1, compute=T),
            verbose=F )

summary(fit2)


fl$fittedm2<-fit2$summary.fitted.values$mean

fl%>%
  mutate(group = ifelse(black==1, "Black", "White"))%>%
  group_by(year, group)%>%
  summarise(mort = mean(fittedm2))%>%
  ggplot()+
  geom_line(aes(y=mort, x=year, color=group), lwd=2)+
  ggtitle("Black/White Mortality Rates in Florida", subtitle = "1980-2010")+
  scale_color_viridis_d(option="C")+
  theme_minimal()
#  facet_wrap(~factor(group) )

fl%>%
  mutate(group = ifelse(black==1, "Black", "White"))%>%
  group_by(year, cofips, group)%>%
  summarise(mort = mean(fittedm2))%>%
  ggplot()+
  geom_line(aes(y=mort, x=year, color=cofips))+
  facet_wrap(~factor(group) )+
  scale_color_viridis_d(option="C")+
  theme_minimal()+
  theme(legend.position = "None")
  
fl%>%
  mutate(group = ifelse(black==1, "Black", "White"))%>%
  filter(cofips %in% c(12073, 12086, 12099))%>%
  mutate(co=ifelse(cofips==12073, "Leon", ifelse(cofips==12086, "Miami-Dade", "Palm Beach")))%>%
  group_by(year, co, group)%>%
  summarise(mort = mean(fittedm2))%>%
  ggplot()+
  geom_line(aes(y=mort, x=year, color=co), lwd=1.25)+
  facet_wrap(~factor(group) )+
  #scale_color_viridis_d(option="C")+
  theme_minimal()+
  ggtitle("Black/White Mortality Rates in Florida", subtitle = "1980-2010")
  
  
  #theme(legend.position = "None")


fls$spre<- fit2$summary.random$struct$mean+ fit2$summary.fixed$mean[1]

fls%>%
  ggplot()+
  geom_sf(aes(fill=spre))+
  scale_fill_viridis_c()+
  ggtitle("Spatial Random Effect")

fls$spre_bl<- fit2$summary.random$struct2$mean + fit2$summary.fixed$mean[1]+fit2$summary.fixed$mean[3]

fls%>%
  ggplot()+
  geom_sf(aes(fill=spre_bl))+
  scale_fill_viridis_c()+
  ggtitle("Spatial Random Effect of Black Disparity")



mod<- std_rate~male+black+year+f(year2,model="iid")+f(conum, model="iid")
fit <- inla(mod,data=sdadata2, family="gaussian", control.predictor = list(link=1, compute=T), verbose=FALSE  )
```



```{r}

mod<- std_rate~male+black+year+f(year2,model="iid")+f(conum, model="iid")
fit <- inla(mod,data=sdadata2, family="gaussian", control.predictor = list(link=1, compute=T), verbose=FALSE  )
```



## Spatial Model Results

```{r, echo=FALSE, fig.height=8, fig.width=10}
load("C:/Users/ozd504/OneDrive - University of Texas at San Antonio//model_fitinla.Rdata")
sts<- tigris::states(cb=T)
library(sf)
library(tigris)
usco<-counties( cb=T)
usco$cofip<-paste(usco$STATEFP, usco$COUNTYFP, sep="")
datco<-unique(sdadata2$cofips)
usco<-usco[usco$cofip%in%datco,]
usco$conum<-1:dim(usco)[1]

usco$bl_re<-fit$summary.fixed$mean[1]+fit$summary.fixed$mean[3]+fit$summary.random$conum_bl$mean
usco$sp_re<-fit$summary.random$conum$mean
#spplot(usco[usco$STATEFP=="54",], "sp_re", at=quantile(usco$sp_re, p=seq(0, 1, .2)), col.regions=RColorBrewer::brewer.pal(n=6, name="RdBu"))

#spplot(usco[usco$STATEFP=="54",], "bl_re", at=quantile(usco$bl_re, p=seq(0, 1, .2)), col.regions=RColorBrewer::brewer.pal(n=6, name="RdBu"))


#spplot(usco[usco$STATEFP=="48",], "sp_re", at=quantile(usco$sp_re, p=seq(0, 1, .2)), col.regions=RColorBrewer::brewer.pal(n=6, name="RdBu"))

#spplot(usco[usco$STATEFP=="48",], "bl_re", at=quantile(usco$bl_re, p=seq(0, 1, .2)), col.regions=RColorBrewer::brewer.pal(n=6, name="RdBu"))

#par(mfrow=c(1,1))

#sdadata2$fitted<-mean(sdadata2$std_rate, na.rm=T) + sd(sdadata2$std_rate, na.rm=T)*fit$summary.fitted.values$mean


##ggplots

msf<-st_as_sf(usco)
sts<-st_as_sf(sts)
#msf_lcc <- st_transform(msf,test)
msf$spre_q<-cut(msf$sp_re, breaks = quantile(c(msf$sp_re), probs = seq(0,1,.2), na.rm = T),include.lowest = T)
msf$blre_q<-cut(msf$bl_re, breaks = quantile(c(msf$bl_re), probs = seq(0,1,.2), na.rm = T),include.lowest = T)

library(ggplot2);library(dplyr); library(forcats)
msf<-st_transform(msf, crs = 2163)
sts<-st_transform(sts, crs=2163)
msf<-msf%>%
  filter(!STATEFP%in%c("02","15", "72" ))
sts<-sts%>%
  filter(!STATEFP%in%c("02","15","60", "66","69", "72", "78"))%>%
  st_boundary()


p1<-ggplot() +
  geom_sf(data=msf,aes(fill = spre_q, color=spre_q)) +
  scale_fill_brewer("Quantile", palette = "RdBu", na.value="grey") +
  scale_color_brewer("Quantile",palette = "RdBu", na.value="grey")+
  geom_sf(data=sts, color="black")+
  ggtitle(label = "Spatial Random Effect")

p2<-ggplot() +
  geom_sf(data=msf,aes(fill = blre_q, color=blre_q)) +
  scale_fill_brewer("Quantile", palette = "RdBu", na.value="grey") +
  scale_color_brewer("Quantile",palette = "RdBu", na.value="grey")+
  geom_sf(data=sts, color="black")+
  ggtitle(label = "Black Random Slope Effect")

plot_layout(p1/p2, nrow = 2)
```



## Model Results
* Fixed effects
```{r, echo=FALSE}
#load("~/Google Drive/fit1.Rdata")
res<-round(fit$summary.fixed[2:5,c(1,3,5)],3)
rownames(res)<-c("Male", "Black", "County_Low_Edu", "High_Segregation")
colnames(res)<-c("Post.Mean", "Lower_BCI", "Upper_BCI")
library(knitr)
res
#kable(res,format = "html",col.names = c("beta", "2.5% BCI", "97.5% BCI"),caption = "Fixed Effects Parameter Estimates"  )
varsum<-1/fit$summary.hyperpar[,c(1,3,5)]
row.names(varsum)<-c("Gaussian var", "Spatial var", "Black RS var")
colnames(varsum)<-c("Post.Mean", "Lower_BCI", "Upper_BCI")
varsum
#round(fit$summary.fixed[2:5,c(1,3,5)],3)
#kable(varsum,format = "html",col.names = c("variance", "2.5% BCI", "97.5% BCI"),caption ="Hyperparameter Estimates" )
#xtable::xtable(varsum, caption ="Hyperparameter Estimates")

```

##Temporal effects of segregation
```{r, echo=FALSE}
res<-fit$summary.fixed[36:65, c(1,3,5)]
res$year<-1981:2010
res$hi<-res$`0.975quant`
res$lo<-res$`0.025quant`
ggplot(data=res,aes(x=year, y=mean))+geom_line( )+geom_ribbon(aes(ymin=lo, ymax=hi, x=year), alpha=.3)+geom_hline(yintercept=0, color="red")+ggtitle("Temporal Effect of High Segregation", subtitle = "1980-2010")

```
